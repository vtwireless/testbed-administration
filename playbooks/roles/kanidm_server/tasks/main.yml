---
# tasks file for kanidm
- name: Install podman
  dnf:
    name: podman
    state: latest

- name: Pull kanidm/server:latest image
  podman_image:
    name: docker.io/kanidm/server
    tag: "{% if ansible_architecture == 'x86_64' %}x86_64_{% endif %}latest"

- name: create kanidm volume
  containers.podman.podman_volume:
    state: present
    name: kanidmd
  register: kanidm_volume

- name: Copy kanidm key into volume
  copy:
    src: "/certs/key.pem"
    dest: "{{ kanidm_volume.volume.Mountpoint }}/key.pem"
    remote_src: yes

- name: Copy kanidm chain into volume
  copy:
    src: "/certs/chain.pem"
    dest: "{{ kanidm_volume.volume.Mountpoint }}/chain.pem"
    remote_src: yes

- name: Make configuration file, perform initial setup if needed
  include_tasks: change_server_toml.yml

- name: Create kanidm pod and service unit file
  containers.podman.podman_container:
    name: kanidm-main
    image: "docker.io/kanidm/server:{% if ansible_architecture == 'x86_64' %}x86_64_{% endif %}latest"
    state: present
    ports:
      - "{{ kanidm_port }}:{{ kanidm_port }}"
    volume:
      - "{{ kanidm_volume.volume.Mountpoint }}:/data"
    privileged: yes
    generate_systemd:
      path: /etc/systemd/system/
      restart_policy: on-failure
      names: true

- name: Make sure kanidm is running
  service:
    name: container-kanidm-main.service
    state: started