---
# tasks file for firewall
- name: "Make sure firewalld is enabled and running"
  service:
    name: firewalld
    enabled: yes
    state: started

# tasks file for firewall_router
#setup
- name: "Make sure firewalld is enabled and running"
  service:
    name: firewalld
    enabled: yes
    state: started
    
- name: "Get device for wan network"
  shell: "ip route | grep {{ public_nets.wan }} | sed 's/^.*dev \\([^ ]*\\).*$/\\1/g'"
  register: wan_dev
  changed_when: false
- debug:
    msg: "Found wan network on device {{ wan_dev.stdout }} "
- name: "Get device for dmz network"
  shell: "ip route | grep {{ int_nets.dmz }} | sed 's/^.*dev \\([^ ]*\\).*$/\\1/g'"
  register: dmz_dev
  changed_when: false
- debug:
    msg: "Found dmz network on device {{ dmz_dev.stdout }}"
- name: "Get device for lan network"
  shell: "ip route | grep {{ int_nets.lan }} | sed 's/^.*dev \\([^ ]*\\).*$/\\1/g'"
  register: lan_dev
  changed_when: false
- debug:
    msg: "Found lan network on device {{ lan_dev.stdout }}"

# zones
- name: "Make sure wan ip range is in appropriate zone"
  firewalld:
    zone: external
    interface: "{{ wan_dev.stdout }}"
    permanent: yes
    immediate: yes
    state: enabled
    when:  "{{int_nets.wan}} in wan_dev.stdout"
- name: "Make sure dmz ip range is in appropriate zone"
  firewalld:
    zone: dmz
    interface: "{{ dmz_dev.stdout }}"
    permanent: yes
    immediate: yes
    state: enabled
    when:  "{{int_nets.wan}} in wan_dev.stdout"
- name: "Make sure lan ip range is in appropriate zone"
  firewalld:
    zone: internal
    interface: "{{ lan_dev.stdout }}"
    permanent: yes
    immediate: yes
    state: enabled

- name: loop zones
  include_tasks: outer_loop.yml
  loop: "{{firewall_rules | dict2items}}"
  loop_control: 
    loop_var: zone
  when: firewall_rules is defined