---
# tasks file for firewall
- name: "Make sure firewalld is enabled and running"
  service:
    name: firewalld
    enabled: yes
    state: started

# tasks file for firewall_router
# start service
- name: "Make sure firewalld is enabled and running"
  service:
    name: firewalld
    enabled: yes
    state: started

# setup interfaces
- name: configure wan
  block:
  - name: "Get device for wan network"
    shell: "ip route | grep {{ public_nets.wan }} | sed 's/^.*dev \\([^ ]*\\).*$/\\1/g'"
    register: dev_wan
    changed_when: false
  - name: "Make sure wan ip range is in appropriate zone"
    firewalld:
      zone: external
      interface: "{{ dev_wan.stdout }}"
      permanent: yes
      immediate: yes
      state: enabled
    register: wan_fw
  
  - name: wan changed
    debug:
      msg: "Found wan network on device {{ dev_wan.stdout }} "
    when: wan_fw.changed
  when:  "(public_nets is defined) and 'wan' in public_nets"

- name: configure dmz
  block:
  - name: "Get device for dmz network"
    shell: "ip route | grep {{ int_nets.dmz }} | sed 's/^.*dev \\([^ ]*\\).*$/\\1/g'"
    register: dev_dmz
    changed_when: false
  - name: "Make sure dmz ip range is in appropriate zone"
    firewalld:
      zone: dmz
      interface: "{{ dev_dmz.stdout }}"
      permanent: yes
      immediate: yes
      state: enabled
    register: dmz_fw
  - name: dmz changed
    debug:
      msg: "Found dmz network on device {{ dev_dmz.stdout }} "
    when: dmz_fw.changed
  when:  "'dmz' in int_nets"

- name: configure lan
  block:
  - name: "Get device for lan network"
    shell: "ip route | grep {{ int_nets.lan }} | sed 's/^.*dev \\([^ ]*\\).*$/\\1/g'"
    register: dev_lan
    changed_when: false
  - name: "Make sure lan ip range is in appropriate zone"
    firewalld:
      zone: internal
      interface: "{{ dev_lan.stdout }}"
      permanent: yes
      immediate: yes
      state: enabled
    register: lan_fw
  - name: lan changed
    debug:
      msg: "Found lan network on device {{ dev_lan.stdout }} "
    when: lan_fw.changed
  when:  "'lan' in int_nets"

# apply rules
- name: loop zones
  include_tasks: outerLoop.yml
  loop: "{{firewall_rules | dict2items}}"
  loop_control: 
    loop_var: zone
  when: firewall_rules is defined